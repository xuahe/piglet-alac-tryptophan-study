---
title: 'Fig6A. The rate of kyunurenine pathway'
author: "Xuan He"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    toc_depth: 3
  html_notebook: 
    toc: true
    toc_depth: 3
---
<style type="text/css">
body{ /* Normal  */ font-size: 12px;}
td {  /* Table  */ font-size: 10px;}
h1.title {font-size: 22px; color: DarkRed; font-style: bold;}
h1 { /* Header 1 */ font-size: 16px; color: mediumblue; font-style: bold;}
h2 { /* Header 2 */ font-size: 13px; color: mediumblue; font-style: bold;}
h3 { /* Header 3 */ font-size: 11px; font-family: "Times New Roman", Times, serif; color: mediumblue;}
code.r{ /* Code block */ font-size: 12px;}
pre { /* Code block - determines code spacing between lines */ font-size: 12px;}
</style>

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/xuanhe89/Documents/WorkSpace/Research projects/Lactation/ALAC/Manuscripts/Paper #1/Figures and Tables R codes')

```


# Clean up the environment
```{r}
rm(list = ls())
```


# Load necessary libraries for data reading, plotting, and statistical analysis
```{r message=FALSE}
library(readxl)       # For reading Excel files
library(ggpubr)       # For creating publication-ready plots
library(dplyr)        # For data manipulation
library(tidyr)        # For reshaping data
library(ggh4x)        # For advanced faceting functions in ggplot2
library(rstatix)      # For statistical tests and adding significance markers
library(knitr)        # For displaying tibbles in a nice table format
library(kableExtra)   # For enhancing table formatting
```


# Load data
```{r}
# Load targeted serum, liver and brain data
Liver <- read_excel("Data/Data.xlsx", sheet = "Liver_targeted")
Brain <- read_excel("Data/Data.xlsx", sheet = "Brain_targeted")
Serum <- read_excel("Data/Data.xlsx", sheet = "Nec_serum_targeted")

# Load pig information and necropsy metadata
PigInfo <- read_excel("Data/Data.xlsx", sheet = "PigInfo")
Nec_metadata <- read_excel("Data/Data.xlsx", sheet = "Nec_metadata")
```


# Data organization

```{r}
Data.serum <- inner_join(Serum, PigInfo, by = "PigID") %>%
                mutate(`KYN:TRP` = Kynurenine / Tryptophan) %>%
                mutate(`(KYN+QUIN):TRP` = (Kynurenine + Quinolinate) / Tryptophan) %>%
                select(Diet, `KYN:TRP`, `(KYN+QUIN):TRP`) %>%
                mutate(Region = "Serum") %>%
                pivot_longer(cols = c(`KYN:TRP`, `(KYN+QUIN):TRP`), names_to = "variable", values_to = "value") %>%
                mutate(Class = "Serum")


Data.liver <- inner_join(Liver, PigInfo, by = "PigID") %>%
                mutate(`KYN:TRP` = Kynurenine / Tryptophan) %>%
                mutate(`(KYN+QUIN):TRP` = (Kynurenine + Quinolinate) / Tryptophan) %>%
                select(Diet, `KYN:TRP`, `(KYN+QUIN):TRP`) %>%
                mutate(Region = "Liver") %>%
                pivot_longer(cols = c(`KYN:TRP`, `(KYN+QUIN):TRP`), names_to = "variable", values_to = "value") %>%
                mutate(Class = "Liver")

Data.brain <- inner_join(Brain, PigInfo, by = "PigID") %>%
                mutate(`KYN:TRP` = Kynurenine / Tryptophan) %>%
                mutate(`(KYN+QUIN):TRP` = (Kynurenine + Quinolinate) / Tryptophan) %>%
                select(Diet, Region, `KYN:TRP`, `(KYN+QUIN):TRP`) %>%  
                pivot_longer(cols = c(`KYN:TRP`, `(KYN+QUIN):TRP`), names_to = "variable", values_to = "value") %>%
                mutate(Class = "Brain")
```


```{r}
# Combine all data into a single dataset
All.data <- bind_rows(Data.serum, Data.liver, Data.brain) %>%
            mutate(Region = factor(Region, levels = c("Serum", "Liver", "Hippocampus", "Hypothalamus", "PFC", "Striatum"))) %>%
            mutate(Class = factor(Class, levels = c("Serum", "Liver", "Brain")))
```

# Plotting data

```{r fig.width=11, fig.height=4}
Fig <- All.data %>% mutate(Diet = factor(Diet, levels = c("ALAC", "WPI", "SF"))) %>%
                      ggerrorplot(x = "variable", y = "value", color = "Diet", 
                                 palette = c("turquoise3","purple", "orange"),
                                 na.rm = TRUE, xlab = "", 
                                 ylab ="Ratio",  add = "mean_se", position = position_dodge(0.7)) +
                      facet_nested(.~ Class + Region , scales = "free") + 
                      theme_classic() 

Fig 
# Save the figure in pdf format
ggsave(plot=Fig, height=4, width=11, dpi=300, filename="Figure 6/Fig6A.pdf", useDingbats=FALSE)

```


# Group difference evaluation
```{r}
All.data %>% group_by(Region, variable) %>%
               wilcox_test(value ~ Diet, p.adjust.method = "none", paired = FALSE) %>% # Perform Wilcoxon test (Mann-Whitney U test)
               select(-p.adj) %>%
               add_significance(p.col = "p", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
               filter(p.signif != "ns") %>%
               select(Region, variable, group1, group2, p, p.signif) %>%
               kable() %>% # Print the tibble in a nicely formatted table
               kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting with kableExtra
```




```{r}
sessionInfo()
```