---
title: 'Fig2A-F. Postprandial response of EAA, Trp:LNAA, Trp, and Trp-derived metabolites'
author: "Xuan He"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    toc_depth: 3
  html_notebook: 
    toc: true
    toc_depth: 3
---
<style type="text/css">
body{ /* Normal  */ font-size: 12px;}
td {  /* Table  */ font-size: 10px;}
h1.title {font-size: 22px; color: DarkRed; font-style: bold;}
h1 { /* Header 1 */ font-size: 16px; color: mediumblue; font-style: bold;}
h2 { /* Header 2 */ font-size: 13px; color: mediumblue; font-style: bold;}
h3 { /* Header 3 */ font-size: 11px; font-family: "Times New Roman", Times, serif; color: mediumblue;}
code.r{ /* Code block */ font-size: 12px;}
pre { /* Code block - determines code spacing between lines */ font-size: 12px;}
</style>

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/xuanhe89/Documents/WorkSpace/Research projects/Lactation/ALAC/Manuscripts/Paper #1/Figures and Tables R codes')
```


# Clean up the environment
```{r}
rm(list = ls())
```


# Load required libraries for data reading, plotting, and data manipulation
```{r message=FALSE}
library(readxl)       # For reading Excel files
library(ggpubr)       # For creating publication-ready plots
library(dplyr)        # For data manipulation
library(rstatix)      # For statistical analysis and adding significance markers
library(reshape2)     # For reshaping data between wide and long formats
library(knitr)        # For displaying tibbles in a nice table format
library(kableExtra)   # For enhancing table formatting
```


# Load data
```{r}
# Untargeted and targeted MS data
PP.untargeted.serum <- read_excel("Data/Data.xlsx", sheet = "PP_serum_untargetedMS")
PP.targeted.serum <- read_excel("Data/Data.xlsx", sheet = "PP_serum_MS")
# Pig info
PigInfo <- read_excel("Data/Data.xlsx", sheet = "PigInfo")
```

# Data organization and create plots

```{r warning=FALSE}
# Create a plot for Total Essential Amino Acids (EAA)
Fig.EAA <- PP.untargeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(EAA = histidine + isoleucine + leucine + lysine + methionine + phenylalanine + threonine + tryptophan + valine) %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "EAA", color = "Diet", ylab = "Total EAA (normalized intensity)", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple")) + yscale("scientific")
```

```{r}
# Create a plot for Tryptophan to other Large Neutral Amino Acid ratio (Trp:LNAA)
# LNAA calculated at the sum of valine, isoleucine, leucine, phenylalanine, and tyrosine.
Fig.Trp_to_LNAA <- PP.untargeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(Trp_to_LNAA = tryptophan / (valine + isoleucine + leucine + phenylalanine + tyrosine)) %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "Trp_to_LNAA", color = "Diet", ylab = "Tryptophan:LNAA", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple"))
```


```{r}
# Create a plot for Tryptophan concentration
Fig.Trp <- PP.targeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "Tryptophan", color = "Diet", ylab = "Tryptophan (uM)", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple"))

```


```{r}
# Create a plot for Kynurenine concentration
Fig.Kyn <- PP.targeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "Kynurenine", color = "Diet", ylab = "Kynurenine (uM)", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple"))
```


```{r}
# Create a plot for Quinolinate concentration
Fig.Quin <- PP.targeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "Quinolinate", color = "Diet", ylab = "Quinolinate (uM)", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple"))
```


```{r}
# Create a plot for Serotonin concentration
Fig.Sere <- PP.targeted.serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(TimePoint = factor(TimePoint, levels = c("baseline", "30 min", "60 min", "120 min"))) %>%
            mutate(Diet = factor(Diet, levels = c("ALAC", "WPI"))) %>%
            ggerrorplot(x = "TimePoint", y = "Serotonin", color = "Diet", ylab = "Serotonin (uM)", xlab = "", add = "mean", error.plot = "errorbar", size = 0.8, position = position_dodge(0.3), palette = c("turquoise3","purple"))
```



```{r fig.width=11, fig.height=7.5}
# Arrange all the individual plots into a single figure
Fig.all <- ggarrange(Fig.EAA,Fig.Trp_to_LNAA, Fig.Trp, Fig.Kyn, Fig.Quin, Fig.Sere, nrow = 2, ncol = 3, common.legend = TRUE)

# save the figure to a pdf file:
ggsave(plot=Fig.all, height=7.5, width=11, dpi=300, filename="Figure 2/Fig2A-F.pdf", useDingbats=FALSE)

Fig.all
```

# Group difference evaluation
```{r}
#This function transforms the input values by the generalized #log function.
glog <- function(y) {
  #Using lambda = 1 
  yt <- log(y+sqrt(y^2+1))
  return(yt)
}
```


## Total EAA
```{r}
# Perform ANOVA for Total EAA
PP.untargeted.serum %>% 
    inner_join(PigInfo, by = "PigID") %>%
    mutate(EAA = histidine + isoleucine + leucine + lysine + methionine + phenylalanine + threonine + tryptophan + valine) %>% # Calculate total EAA
    mutate(glog.EAA = glog(EAA)) %>% # apply glog transformation
    select(SowID, glog.EAA, Diet, TimePoint) %>%
    group_by(TimePoint) %>%
    anova_test(glog.EAA ~ Diet + SowID, type = 1) %>%
    as_tibble() %>%
    filter(Effect == "Diet") %>% # Select relevant columns for reporting
    kable() %>% # Print the tibble in a nice table format
    kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```


## Tryptophan:LNAA
```{r}
# Perform ANOVA for Tryptophan:LNAA ratio
PP.untargeted.serum %>% 
    inner_join(PigInfo, by = "PigID") %>%
    mutate(Trp_to_LNAA = tryptophan / (valine + isoleucine + leucine + phenylalanine + tyrosine)) %>% # Calculate Trp to LNAA ratio
    mutate(glog.Trp_to_LNAA = glog(Trp_to_LNAA * 100)) %>% # Scale values by 100 and apply glog transformation
    select(SowID, glog.Trp_to_LNAA, Diet, TimePoint) %>%
    group_by(TimePoint) %>%
    anova_test(glog.Trp_to_LNAA ~ Diet + SowID, type = 1) %>%
    as_tibble() %>%
    filter(Effect == "Diet") %>% # Select relevant columns for reporting
    kable() %>% # Print the tibble in a nice table format
    kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```

## Results from targeted metabolomics data (Tryptophan, Kynurenine, Quinolinate, Serotonin)

```{r}
# Perform ANOVA for targeted metabolomics data
PP.targeted.serum %>% 
    select(Tryptophan, Kynurenine, Quinolinate, Serotonin) %>%
    mutate(across(everything(), ~ glog(.x * 10))) %>% # Scale values by 10 and apply generalized log 
    mutate(TimePoint = PP.targeted.serum$TimePoint) %>%
    mutate(PigID = PP.targeted.serum$PigID) %>%
    inner_join(PigInfo, by = "PigID") %>%
    select(Tryptophan, Kynurenine, Quinolinate, Serotonin, Diet, TimePoint, SowID) %>%
    melt(id = c("TimePoint", "SowID", "Diet")) %>%
    group_by(TimePoint, variable) %>%
    anova_test(value ~ Diet + SowID, type = 1) %>%
    as_tibble() %>%
    filter(Effect == "Diet") %>%
    add_significance(p.col = "p", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
    filter(p.signif != "ns") %>%
    select(TimePoint, variable, p, p.signif) %>% # Select relevant columns for reporting
    kable() %>% # Print the tibble in a nice table format
    kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```


```{r}
sessionInfo()
```