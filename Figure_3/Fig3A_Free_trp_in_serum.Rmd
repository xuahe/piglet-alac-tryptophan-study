---
title: 'Fig3A. Free trp and % free trp in serum (at necropsy)'
author: "Xuan He"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    toc_depth: 3
  html_notebook: 
    toc: true
    toc_depth: 3
---
<style type="text/css">
body{ /* Normal  */ font-size: 12px;}
td {  /* Table  */ font-size: 10px;}
h1.title {font-size: 22px; color: DarkRed; font-style: bold;}
h1 { /* Header 1 */ font-size: 16px; color: mediumblue; font-style: bold;}
h2 { /* Header 2 */ font-size: 13px; color: mediumblue; font-style: bold;}
h3 { /* Header 3 */ font-size: 11px; font-family: "Times New Roman", Times, serif; color: mediumblue;}
code.r{ /* Code block */ font-size: 12px;}
pre { /* Code block - determines code spacing between lines */ font-size: 12px;}
</style>

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/xuanhe89/Documents/WorkSpace/Research projects/Lactation/ALAC/Manuscripts/Paper #1/Figures and Tables R codes')
```


# Clean up the environment
```{r}
rm(list = ls())
```


# Load required libraries for data reading, plotting, and data manipulation
```{r message=FALSE}
library(readxl)       # For reading Excel files
library(ggpubr)       # For creating publication-quality plots
library(dplyr)        # For data manipulation
library(rstatix)      # For statistical analysis and adding significance markers
library(knitr)        # For displaying tibbles in a nice table format
library(kableExtra)   # For enhancing table formatting
```


# Load data
```{r}
# Serum metabolome data at necropsy
Serum <- read_excel("Data/Data.xlsx", sheet = "Nec_serum_targeted")

# Pig info
PigInfo <- read_excel("Data/Data.xlsx", sheet = "PigInfo")
# Metadata related to necropsy, including feed intake information
Nec_metadata <- read_excel("Data/Data.xlsx", sheet = "Nec_metadata")
```


# Data organization and figure generation
```{r fig.width=2.6, fig.height=4}
# Join serum data with pig information, reorder diet levels, and create an error plot for serum free tryptophan
Fig1 <- Serum %>% inner_join(PigInfo, by = "PigID") %>%
          mutate(Diet = factor(Diet, levels = c("ALAC", "WPI", "SF"))) %>%
          ggerrorplot(y = "Free.Tryptophan", x = "Diet", color = "Diet", 
            palette = c("turquoise3", "purple", "orange"),
            na.rm = TRUE, 
            ylab = "Serum free tryptophan (uM)", 
            xlab = "", 
            add = "mean_se", 
            size = 0.6) +
            theme_classic2() +
          theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Save the figure in pdf format
ggsave(plot=Fig1, height=4, width=2.6, dpi=300, filename="Figure 3/Fig3A_left.pdf", useDingbats=FALSE)

Fig1
```

# Evaluate group difference
```{r}
#This function transforms the input values by the generalized #log function.
glog <- function(y) {
  #Using lambda = 1 
  yt <- log(y+sqrt(y^2+1))
  return(yt)
}
```

## Free Trp - between ALAC and WPI (adjust for Sow ID, formula volume and postprandial time)
```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
            filter(Diet %in% c("ALAC", "WPI")) %>%
            mutate(glog.Free.Tryptophan = glog(Free.Tryptophan * 10)) %>% # Apply generalized log transformation
            anova_test(glog.Free.Tryptophan ~ Diet + SowID + Formula.consumed.g + Time.postprandial.min, type = 1)
```

## Free Trp - between formula-fed groups and SF (adjust for Sow ID)
```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(glog.Free.Tryptophan = glog(Free.Tryptophan*10)) %>%
            tukey_hsd(glog.Free.Tryptophan ~ Diet + SowID, type = 1) %>% # Perform Tukey's HSD test
            filter(term == "Diet") %>%
            add_significance(p.col = "p.adj", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
            kable() %>% # Print the tibble in a nice table format
            kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```

## Estiamte % of free trp
```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(Per_free_trp = Free.Tryptophan / Tryptophan * 100) %>%
            get_summary_stats(Per_free_trp, type = "common") %>% # Get summary statistics for percentage of free tryptophan
            kable() # Print the tibble in a nice table format
```

```{r fig.width=2.6, fig.height=4}
Fig2 <- Serum %>% inner_join(PigInfo, by = "PigID") %>%
          mutate(Per_free_trp = Free.Tryptophan / Tryptophan * 100) %>%
          mutate(Diet = factor(Diet, levels = c("ALAC", "WPI", "SF"))) %>%
          ggerrorplot(y = "Per_free_trp", x = "Diet", color = "Diet", 
            palette = c("turquoise3", "purple", "orange"),
            na.rm = TRUE, 
            ylab = "% of free tryptophan", 
            xlab = "", 
            add = "mean_se", 
            size = 0.6) +
            theme_classic2() +
            theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

Fig2

# save the figure in pdf format:
ggsave(plot=Fig2, height=4, width=2.6, dpi=300, filename="Figure 3/Fig3A_right.pdf", useDingbats=FALSE)
```


## % free Trp - between ALAC and WPI (adjust for Sow ID, formula volume and postprandial time)
```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
          mutate(Per_free_trp = Free.Tryptophan / Tryptophan * 100) %>%
          filter(Diet %in% c("ALAC", "WPI")) %>%
          anova_test(Per_free_trp ~ Diet + SowID + Formula.consumed.g + Time.postprandial.min, type = 1)
```

## % free Trp - between formula-fed groups and SF (adjust for Sow ID)

```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
            mutate(Per_free_trp = Free.Tryptophan / Tryptophan * 100) %>%
            tukey_hsd(Per_free_trp ~ Diet + SowID, type = 1) %>%
            filter(term == "Diet") %>%
            add_significance(p.col = "p.adj", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
            kable() %>% # Print the tibble in a nice table format
            kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```


```{r}
sessionInfo()
```