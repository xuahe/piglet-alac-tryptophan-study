---
title: 'Fig4B. Trp metabolites correlation'
author: "Xuan He"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    toc_depth: 3
  html_notebook: 
    toc: true
    toc_depth: 3
---
<style type="text/css">
body{ /* Normal  */ font-size: 12px;}
td {  /* Table  */ font-size: 10px;}
h1.title {font-size: 22px; color: DarkRed; font-style: bold;}
h1 { /* Header 1 */ font-size: 16px; color: mediumblue; font-style: bold;}
h2 { /* Header 2 */ font-size: 13px; color: mediumblue; font-style: bold;}
h3 { /* Header 3 */ font-size: 11px; font-family: "Times New Roman", Times, serif; color: mediumblue;}
code.r{ /* Code block */ font-size: 12px;}
pre { /* Code block - determines code spacing between lines */ font-size: 12px;}
</style>

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/xuanhe89/Documents/WorkSpace/Research projects/Lactation/ALAC/Manuscripts/Paper #1/Figures and Tables R codes')
```


# Clean up the environment
```{r}
rm(list = ls())
```


# Load required libraries for data reading, plotting, and data manipulation
```{r message=FALSE}
library(readxl)       # For reading Excel files
library(ggpubr)       # For creating publication-ready plots
library(dplyr)        # For data manipulation
library(rstatix)      # For statistical tests and adding significance markers
library(knitr)        # For displaying tibbles in a nice table format
library(kableExtra)   # For enhancing table formatting
```


# Load data
```{r}
# Load targeted serum, liver, brain and urine data
Serum <- read_excel("Data/Data.xlsx", sheet = "Nec_serum_targeted")
Liver <- read_excel("Data/Data.xlsx", sheet = "Liver_targeted")
Brain <- read_excel("Data/Data.xlsx", sheet = "Brain_targeted")
Urine <- read_excel("Data/Data.xlsx", sheet = "Nec_urine_NMR")

# Load group information and necropsy metadata
PigInfo <- read_excel("Data/Data.xlsx", sheet = "PigInfo")
Nec_metadata <- read_excel("Data/Data.xlsx", sheet = "Nec_metadata")
```


# Data organization
```{r}
# Define the list of metabolites for each tissue/biofluid type
ls.serum.metabolites <- c("Tryptophan", "Kynurenine", "Quinolinate", "Niacinamide", "Serotonin")
ls.liver.metabolites <- c("Tryptophan", "Kynurenine", "Quinolinate", "Niacinamide", "NAD+", "Serotonin")
ls.brain.metabolites <- c("Tryptophan", "Kynurenine", "Quinolinate", "Serotonin")
ls.urine.metabolites <- c("Tryptophan", "Quinolinate", "Niacinamide", "1-Methylnicotinamide", "3-Indoxylsulfate", "N-Methyl-2-pyridone-5-carboxamide")
```


```{r}
Data.serum <- Serum %>% 
                select(PigID, all_of(ls.serum.metabolites)) %>%
                rename_with(~ paste0("Serum_", .), ls.serum.metabolites)

Data.liver <- Liver %>% 
                select(PigID, all_of(ls.liver.metabolites)) %>%
                rename_with(~ paste0("Liver_", .), ls.liver.metabolites)


Data.hippocampus <- Brain %>% 
                      filter(Region == "Hippocampus") %>%
                      select(PigID, all_of(ls.brain.metabolites)) %>%
                      rename_with(~ paste0("Hippocampus_", .), ls.brain.metabolites)


Data.hypothalamus <- Brain %>% 
                        filter(Region == "Hypothalamus") %>%
                        select(PigID, all_of(ls.brain.metabolites)) %>%
                        rename_with(~ paste0("Hypothalamus_", .), ls.brain.metabolites)

Data.PFC <- Brain %>% 
              filter(Region == "PFC") %>%
              select(PigID, all_of(ls.brain.metabolites)) %>%
              rename_with(~ paste0("PFC_", .), ls.brain.metabolites)


Data.striatum <- Brain %>% 
                    filter(Region == "Striatum") %>%
                    select(PigID, all_of(ls.brain.metabolites)) %>%
                    rename_with(~ paste0("Striatum_", .), ls.brain.metabolites)


#Calculate effective osmolality
Effective.Osmolality <- Urine$`Urine osmolality` - (Urine$Urea/1000)

Data.urine <- Urine %>% mutate(across(everything(), ~ .x / Effective.Osmolality * 100)) %>% # Adjust metabolite concentrations based on effective osmolality
                          mutate(PigID = Urine$PigID) %>%  # Adding PigID to Data.urine0
                          select(PigID, all_of(ls.urine.metabolites)) %>%
                          rename_with(~ paste0("Urine_", .), ls.urine.metabolites)
```

```{r}
Data.all <- inner_join(Data.serum, Data.liver, by = "PigID") %>%
              inner_join(Data.hippocampus, by = "PigID") %>%
              inner_join(Data.hypothalamus, by = "PigID") %>%
              inner_join(Data.PFC, by = "PigID") %>%
              inner_join(Data.striatum, by = "PigID") %>%
              inner_join(Data.urine, by = "PigID")
```


# Calcualte spearman correlation between tryptophan and its metabolism products
```{r}
Overall.cor <- Data.all %>% select(-PigID) %>% cor_test(method = "spearman")

# Define pairs of variables for which correlation is of interest
pairs_to_keep <- data.frame(
                    # relationship between serum trp and trp in tissue and urine:
                    var1 = "Serum_Tryptophan", var2 = "Liver_Tryptophan") %>%
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "Hippocampus_Tryptophan")) %>%
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "Hypothalamus_Tryptophan")) %>%
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "PFC_Tryptophan")) %>%
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "Striatum_Tryptophan")) %>%
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "Urine_Tryptophan")) %>%
                    # relationship between serum trp, indole and urine 3-indoxylsulfate
                    bind_rows(c(var1 = "Serum_Tryptophan", var2 = "Urine_3-Indoxylsulfate")) %>%
                    # relationship between brain trp and brain serotonin
                    bind_rows(c(var1 = "Hippocampus_Tryptophan", var2 = "Hippocampus_Serotonin")) %>%
                    bind_rows(c(var1 = "Hypothalamus_Tryptophan", var2 = "Hypothalamus_Serotonin")) %>%
                    bind_rows(c(var1 = "PFC_Tryptophan", var2 = "PFC_Serotonin")) %>%
                    bind_rows(c(var1 = "Striatum_Tryptophan", var2 = "Striatum_Serotonin")) %>%
                    # relationship between brain serotonin and serum serotonin
                    bind_rows(c(var1 = "Hippocampus_Serotonin", var2 = "Serum_Serotonin")) %>%
                    bind_rows(c(var1 = "Hypothalamus_Serotonin", var2 = "Serum_Serotonin")) %>%
                    bind_rows(c(var1 = "PFC_Serotonin", var2 = "Serum_Serotonin")) %>%
                    bind_rows(c(var1 = "Striatum_Serotonin", var2 = "Serum_Serotonin")) %>%
  
                    # relationships relate to kynurenine pathway in brain:
                    bind_rows(c(var1 = "Hippocampus_Tryptophan", var2 = "Hippocampus_Kynurenine")) %>%
                    bind_rows(c(var1 = "Hippocampus_Kynurenine", var2 = "Hippocampus_Quinolinate")) %>%
                    bind_rows(c(var1 = "Hypothalamus_Tryptophan", var2 = "Hypothalamus_Kynurenine")) %>%
                    bind_rows(c(var1 = "Hypothalamus_Kynurenine", var2 = "Hypothalamus_Quinolinate")) %>%
                    bind_rows(c(var1 = "PFC_Tryptophan", var2 = "PFC_Kynurenine")) %>%
                    bind_rows(c(var1 = "PFC_Kynurenine", var2 = "PFC_Quinolinate")) %>%
                    bind_rows(c(var1 = "Striatum_Tryptophan", var2 = "Striatum_Kynurenine")) %>%
                    bind_rows(c(var1 = "Striatum_Kynurenine", var2 = "Striatum_Quinolinate")) %>%
                    
                    # relationships relate to kynurenine pathway in liver:
                    bind_rows(c(var1 = "Liver_Tryptophan", var2 = "Liver_Kynurenine")) %>%
                    bind_rows(c(var1 = "Liver_Kynurenine", var2 = "Liver_Quinolinate")) %>%
                    bind_rows(c(var1 = "Liver_Quinolinate", var2 = "Liver_NAD+")) %>%
  
                    # relationship between NAD+ and urine tryptophan metabolites
                    bind_rows(c(var1 = "Liver_NAD+", var2 = "Urine_1-Methylnicotinamide")) %>%
                    bind_rows(c(var1 = "Liver_NAD+", var2 = "Urine_N-Methyl-2-pyridone-5-carboxamide")) %>%

                    # relationships relate to brain kynurenine and serum kynurenine
                    bind_rows(c(var1 = "Hippocampus_Kynurenine", var2 = "Serum_Kynurenine")) %>%
                    bind_rows(c(var1 = "Hypothalamus_Kynurenine", var2 = "Serum_Kynurenine")) %>%
                    bind_rows(c(var1 = "PFC_Kynurenine", var2 = "Serum_Kynurenine")) %>%
                    bind_rows(c(var1 = "Striatum_Kynurenine", var2 = "Serum_Kynurenine")) %>%
  
                    # relationships relate to serum kynurenine and liver kynurenine
                    bind_rows(c(var1 = "Serum_Kynurenine", var2 = "Liver_Kynurenine")) %>%

                    # relationships relate to serum quinolinate and liver & urine quinolinate
                    bind_rows(c(var1 = "Serum_Quinolinate", var2 = "Liver_Quinolinate")) %>%
                    bind_rows(c(var1 = "Serum_Quinolinate", var2 = "Urine_Quinolinate")) 
                    
  
subset.cor <- Overall.cor %>% semi_join(pairs_to_keep, by = c("var1", "var2")) %>% 
                add_significance()
```


```{r}
subset.cor %>% filter(p.signif != "ns") %>%
            kable() %>% # Print the tibble in a nice table format
            kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```


```{r}
sessionInfo()
```