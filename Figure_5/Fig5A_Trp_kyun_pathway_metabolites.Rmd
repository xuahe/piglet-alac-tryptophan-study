---
title: 'Fig5A. Trp Kynurenine pathway metabolites'
author: "Xuan He"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    toc_depth: 3
  html_notebook: 
    toc: true
    toc_depth: 3
---
<style type="text/css">
body{ /* Normal  */ font-size: 12px;}
td {  /* Table  */ font-size: 10px;}
h1.title {font-size: 22px; color: DarkRed; font-style: bold;}
h1 { /* Header 1 */ font-size: 16px; color: mediumblue; font-style: bold;}
h2 { /* Header 2 */ font-size: 13px; color: mediumblue; font-style: bold;}
h3 { /* Header 3 */ font-size: 11px; font-family: "Times New Roman", Times, serif; color: mediumblue;}
code.r{ /* Code block */ font-size: 12px;}
pre { /* Code block - determines code spacing between lines */ font-size: 12px;}
</style>

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/xuanhe89/Documents/WorkSpace/Research projects/Lactation/ALAC/Manuscripts/Paper #1/Figures and Tables R codes')

```


# Clean up the environment
```{r}
rm(list = ls())
```


# Load necessary libraries for reading data, plotting, and statistical analysis
```{r message=FALSE}
library(readxl)       # For reading Excel files
library(ggpubr)       # For creating publication-ready plots
library(dplyr)        # For data manipulation
library(tidyr)        # For reshaping data
library(ggh4x)        # For advanced facetting functions in ggplot2
library(rstatix)      # For statistical tests and adding significance markers
library(knitr)        # For displaying tibbles in a nice table format
library(kableExtra)   # For enhancing table formatting
```


# Load data
```{r}
# Load targeted serum, liver, brain, and urine data from the Excel file
Serum <- read_excel("Data/Data.xlsx", sheet = "Nec_serum_targeted")
Liver <- read_excel("Data/Data.xlsx", sheet = "Liver_targeted")
Brain <- read_excel("Data/Data.xlsx", sheet = "Brain_targeted")
Urine <- read_excel("Data/Data.xlsx", sheet = "Nec_urine_NMR")

# Pig info
PigInfo <- read_excel("Data/Data.xlsx", sheet = "PigInfo")
# Metadata related to necropsy, including feed intake information
Nec_metadata <- read_excel("Data/Data.xlsx", sheet = "Nec_metadata")
```


# Data organization

```{r}
# Define the list of metabolites for each tissue type
ls.serum.metabolites <- c("Tryptophan", "Kynurenine", "Quinolinate", "Serotonin")
ls.liver.metabolites <- c("Tryptophan", "Kynurenine", "Quinolinate", "NAD", "NAD+NADP","Serotonin")
ls.brain.metabolites <- c("Tryptophan", "Serotonin")
ls.urine.metabolites <- c("Tryptophan", "Quinolinate", "1-MN", "3-IS", "2PY")
```

```{r}
Data.serum <- inner_join(Serum, PigInfo, by = "PigID") %>%
               select(Diet, all_of(ls.serum.metabolites)) %>%
               mutate(Region = "Serum") %>%
               pivot_longer(cols = -c(Diet, Region), names_to = "variable", values_to = "value") %>%
               mutate(Class = "I")


Data.liver <- inner_join(Liver, PigInfo, by = "PigID") %>%
               mutate(`NAD+NADP` = `NAD+` + `NADP+`) %>%
               rename(`NAD` = "NAD+") %>% # fix name
               select(Diet, all_of(ls.liver.metabolites)) %>%
               mutate(Region = "Liver") %>%
               pivot_longer(cols = -c(Diet, Region), names_to = "variable", values_to = "value") %>%
               mutate(Class = "II")

Data.brain <- inner_join(Brain, PigInfo, by = "PigID") %>%
               select(Diet, Region, all_of(ls.brain.metabolites)) %>%
               pivot_longer(cols = -c(Diet, Region), names_to = "variable", values_to = "value") %>%
               mutate(Class = "II")


#Calculate effective osmolality
Effective.Osmolality <- Urine$`Urine osmolality` - (Urine$Urea/1000)

Data.urine <- Urine %>%
                rename(`1-MN` = "1-Methylnicotinamide") %>% # fix name
                rename(`2PY` = "N-Methyl-2-pyridone-5-carboxamide") %>% # fix name
                rename(`3-IS` = "3-Indoxylsulfate") %>% # fix name
                mutate(across(`1-MN`:`β-Pseudouridine`, ~ .x / Effective.Osmolality)) %>% # Osmolality adjustment
                inner_join(PigInfo, by = "PigID") %>%
                select(Diet, all_of(ls.urine.metabolites)) %>%
                mutate(Region = "Urine") %>%
                pivot_longer(cols = -c(Diet, Region), names_to = "variable", values_to = "value") %>%
                mutate(Class = "III")
```

```{r}
All.data <- bind_rows(Data.serum, Data.liver, Data.brain, Data.urine) %>%
            mutate(Region = factor(Region, levels = c("Serum", "Liver", "Hippocampus", "Hypothalamus", "PFC", "Striatum", "Urine")))
```


```{r fig.width=13, fig.height=4}
Fig <- All.data %>% 
          filter(variable %in% c("Kynurenine", "Quinolinate", "NAD+", "1-MN", "3-IS", "2PY", "NAD", "NAD+NADP")) %>%
          mutate(Diet = factor(Diet, levels = c("ALAC", "WPI", "SF"))) %>%
          ggerrorplot(x = "variable", y = "value", color = "Diet", 
              palette = c("turquoise3", "purple", "orange"),
              na.rm = TRUE, 
              xlab = "", 
              ylab = "Concentration", 
              add = "mean_se", 
              size = 0.6,
              position = position_dodge(0.7)) +
              facet_nested(~Region + variable, scales = "free", independent = "y") +  # Free x axis with proportional facet widths using facet_nested
              theme_classic2() +
              theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

Fig

# save the figure in pdf:
ggsave(plot=Fig, height=4, width=13, dpi=300, filename="Figure 5/Fig5A.pdf", useDingbats=FALSE)
```

# Evaluate group differences
```{r}
#This function transforms the input values by the generalized #log function.
glog <- function(y) {
  #Using lambda = 1 
  yt <- log(y+sqrt(y^2+1))
  return(yt)
}
```


## ALAC vs WPI: Serum and liver data, adjusting for intake volume and postprandial time

```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
          select(Kynurenine, Quinolinate, Diet, SowID, Formula.consumed.g, Time.postprandial.min) %>%
          pivot_longer(cols = -c(Diet, SowID, Formula.consumed.g, Time.postprandial.min), names_to = "variable", values_to = "value") %>%
          filter(Diet %in% c("ALAC", "WPI")) %>%
          group_by(variable) %>%
          mutate(glog.value = glog(value*10)) %>%
          anova_test(glog.value ~ Diet + SowID + Formula.consumed.g + Time.postprandial.min, type = 1) %>%
          as_tibble() %>%
          filter(Effect == "Diet") %>%
          kable() %>% # Print the tibble in a nice table format
          kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```

```{r}
Liver %>% mutate(`NAD+NADP` = `NAD+` + `NADP+`) %>%
          inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
          select(Kynurenine, Quinolinate, `NAD+`, `NAD+NADP`, Diet, SowID, Formula.consumed.g, Time.postprandial.min) %>%
          pivot_longer(cols = -c(Diet, SowID, Formula.consumed.g, Time.postprandial.min), names_to = "variable", values_to = "value") %>%
          filter(Diet %in% c("ALAC", "WPI")) %>%
          group_by(variable) %>%
          mutate(glog.value = glog(value*10)) %>%
          anova_test(glog.value ~ Diet + SowID + Formula.consumed.g + Time.postprandial.min, type = 1) %>%
          as_tibble() %>%
          filter(Effect == "Diet") %>%
          kable() %>% # Print the tibble in a nice table format
          kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```
 
## Between formula-fed groups and SF, adjusting for sow ID
```{r}
Serum %>% inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
          select(Kynurenine, Quinolinate, Diet, SowID) %>%
          pivot_longer(cols = -c(Diet, SowID), names_to = "variable", values_to = "value") %>%
          group_by(variable) %>%
          mutate(glog.value = glog(value*10)) %>%
          tukey_hsd(glog.value ~ Diet + SowID) %>%
          filter(term == "Diet") %>%
          add_significance(p.col = "p.adj", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
          filter(p.adj.signif != "ns") %>%
          kable() %>% # Print the tibble in a nice table format
          kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```

```{r}
Liver %>% mutate(`NAD+NADP` = `NAD+` + `NADP+`) %>%
          inner_join(PigInfo, by = "PigID") %>%
          inner_join(Nec_metadata, by = "PigID") %>%
          select(Kynurenine, Quinolinate, `NAD+`, `NAD+NADP`, Diet, SowID) %>%
          pivot_longer(cols = -c(Diet, SowID), names_to = "variable", values_to = "value") %>%
          group_by(variable) %>%
          mutate(glog.value = glog(value*10)) %>%
          tukey_hsd(glog.value ~ Diet + SowID) %>%
          filter(term == "Diet") %>%
          add_significance(p.col = "p.adj", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
          filter(p.adj.signif != "ns") %>%
          kable() %>% # Print the tibble in a nice table format
          kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```

## Urine data, adjusting for sow ID
```{r}
Urine %>% mutate(across(`1-Methylnicotinamide`:`β-Pseudouridine`, ~ .x / Effective.Osmolality)) %>% # osmolality adjustment
                inner_join(PigInfo, by = "PigID") %>%
                select(Quinolinate, `1-Methylnicotinamide`, `3-Indoxylsulfate`, `N-Methyl-2-pyridone-5-carboxamide`, Diet, SowID) %>%
                pivot_longer(cols = -c(Diet, SowID), names_to = "variable", values_to = "value") %>%
                group_by(variable) %>%
                mutate(glog.value = glog(value*10)) %>%
                tukey_hsd(glog.value ~ Diet + SowID) %>%
                filter(term == "Diet") %>%
                add_significance(p.col = "p.adj", cutpoints = c(0, 0.05, 0.1, 1), symbols = c("*", "#", "ns")) %>%
                filter(p.adj.signif != "ns") %>%
                kable() %>% # Print the tibble in a nice table format
                kable_styling(bootstrap_options = c("striped", "hover")) # Enhance table formatting
```



```{r}
sessionInfo()
```